<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bona+Nova+SC:ital,wght@0,400;0,700;1,400&family=Cal+Sans&family=Changa+One:ital@0;1&family=Limelight&family=Lobster&family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&family=Oswald:wght@200..700&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/styles.css"> 
    <title>FX Wizard</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': 'dodgerblue',
                        'secondary': '#f97316',
                        'bg-dark': '#333333',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-bg-dark text-white min-h-screen w-full p-0">

    <div id="app" class="w-full h-full"> 
        <!-- Connection Status -->
        <div id="controller-status" class="mb-1 text-sm p-3 bg-gray-600 w-full">
            Connection Status: <span id="controller-connection" class="font-medium text-red-400">CLOSED</span>
        </div>

        <div id="controller-view" class="interface-view mb-5 hidden controller-max-width mx-auto">
            <div class="space-y-3 p-2 rounded-lg w-full">
                <!-- Text Inputs -->
                <div class="flex flex-col gap-2">
                    <div class="w-full">
                        <label for="button-name-input" class="block text-md font-medium mb-1">Name:</label>
                        <input type="text" id="button-name-input" placeholder="Name" class="w-full p-2 rounded border-2 border-white bg-transparent text-white text-sm focus:bg-gray-500" maxlength="50">
                    </div>
                    <div class="w-full">
                        <label for="title-input" class="block text-md font-medium mb-1">Title:</label>
                        <input type="text" id="title-input" placeholder="Title" class="w-full p-2 rounded border-2 border-white bg-transparent text-white text-sm focus:bg-gray-500" maxlength="50">
                    </div>
                </div>

                <div class="w-full">
                    <label for="duration-input" class="block text-md font-medium mb-1">Duration (sec):</label>
                    <input type="number" id="duration-input" value="5" class="w-full p-2 rounded border-2 border-white bg-transparent text-white text-sm focus:bg-gray-500">
                </div>

                <!-- Background Color -->
                <div>
                    <p class="block text-md font-medium mb-1 text-center">Background Color:</p>
                    <div id="bg-selector" class="grid grid-cols-2 gap-1">
                        <input type="radio" id="bg-blue" name="bgStyle" value="blue" checked class="hidden peer/b1">
                        <label for="bg-blue" class="p-1 border rounded text-center cursor-pointer text-md peer-checked/b1:bg-blue-600">Blue</label>
                        
                        <input type="radio" id="bg-green" name="bgStyle" value="green" class="hidden peer/b2">
                        <label for="bg-green" class="p-1 border rounded text-center cursor-pointer text-md peer-checked/b2:bg-green-600">Green</label>
                        
                        <input type="radio" id="bg-black" name="bgStyle" value="black" class="hidden peer/b3">
                        <label for="bg-black" class="p-1 border rounded text-center cursor-pointer text-md peer-checked/b3:bg-black">Black</label>

                        <input type="radio" id="bg-red" name="bgStyle" value="red" class="hidden peer/b4">
                        <label for="bg-red" class="p-1 border rounded text-center cursor-pointer text-md peer-checked/b4:bg-red-700">Red</label>
                    </div>
                </div>

                <!-- Font Styles -->
                <div>
                    <p class="block text-md font-medium mb-1 text-center">Font Style:</p>
                    <div id="font-selector" class="grid grid-cols-3 gap-1 text-[12px]">
                        <input type="radio" id="font-default" name="fontStyle" value="font-default" checked class="hidden peer/f1">
                        <label for="font-default" class="p-1 border rounded text-center cursor-pointer peer-checked/f1:bg-primary">Default</label>
                        <input type="radio" id="font-script" name="fontStyle" value="font-script" class="hidden peer/f2">
                        <label for="font-script" class="p-1 border rounded text-center cursor-pointer peer-checked/f2:bg-primary font-script">Script</label>
                        <input type="radio" id="font-fun" name="fontStyle" value="font-fun" class="hidden peer/f3">
                        <label for="font-fun" class="p-1 border rounded text-center cursor-pointer peer-checked/f3:bg-primary font-fun">Fun</label>
                        <input type="radio" id="font-modern" name="fontStyle" value="font-modern" class="hidden peer/f4">
                        <label for="font-modern" class="p-1 border rounded text-center cursor-pointer peer-checked/f4:bg-primary font-modern">Modern</label>
                        <input type="radio" id="font-classic" name="fontStyle" value="font-classic" class="hidden peer/f5">
                        <label for="font-classic" class="p-1 border rounded text-center cursor-pointer peer-checked/f5:bg-primary font-classic">Classic</label>
                        <input type="radio" id="font-accent" name="fontStyle" value="font-accent" class="hidden peer/f6">
                        <label for="font-accent" class="p-1 border rounded text-center cursor-pointer peer-checked/f6:bg-primary font-accent">Accent</label>
                    </div>
                </div>

                <!-- Stable Animations -->
                <div>
                    <p class="block text-md font-medium mb-1 text-center">Animation:</p>
                    <div id="animation-selector" class="grid grid-cols-3 gap-1 text-[12px]">
                        <input type="radio" id="anim-slideUp" name="animationStyle" value="anim-slideUp" checked class="hidden peer/a1">
                        <label for="anim-slideUp" class="p-1 flex justify-center items-center border rounded text-center cursor-pointer peer-checked/a1:bg-primary">Slide Up</label>
                        <input type="radio" id="anim-fade" name="animationStyle" value="anim-fade" class="hidden peer/a2">
                        <label for="anim-fade" class="p-1 flex justify-center items-center border rounded text-center cursor-pointer peer-checked/a2:bg-primary">Fade In</label>
                        <input type="radio" id="anim-slideLeft" name="animationStyle" value="anim-slideLeft" class="hidden peer/a3">
                        <label for="anim-slideLeft" class="p-1 flex justify-center items-center border rounded text-center cursor-pointer peer-checked/a3:bg-primary">Slide Left</label>
                        <input type="radio" id="spin" name="animationStyle" value="anim-spinIn" class="hidden peer/a4">
                        <label for="spin" class="p-1 flex justify-center items-center border rounded text-center cursor-pointer peer-checked/a4:bg-primary">Spin</label>
                        
                        <input type="radio" id="slideRight" name="animationStyle" value="anim-slideRight" class="hidden peer/a5">
                        <label for="slideRight" class="p-1 flex justify-center items-center border rounded text-center cursor-pointer peer-checked/a5:bg-primary">Slide Right</label> 
                         <input type="radio" id="slideDown" name="animationStyle" value="anim-slideDown" class="hidden peer/a6">
                        <label for="slideDown" class="p-1 flex justify-center items-center border rounded text-center cursor-pointer peer-checked/a6:bg-primary">Slide Down</label>

                    </div>
                </div>

                <!-- Locations -->
                <div>
                    <p class="block text-md font-medium mb-1 text-center">Location:</p>
                    <div id="location-selector" class="grid grid-cols-3 gap-1 text-[18px]">
                        <input type="radio" id="loc-TL" name="location" value="Top Left" class="hidden peer/l1"><label for="loc-TL" class="border p-1 text-center cursor-pointer peer-checked/l1:bg-primary">‚Üñ</label>
                        <input type="radio" id="loc-TM" name="location" value="Top Middle" class="hidden peer/l2"><label for="loc-TM" class="border p-1 text-center cursor-pointer peer-checked/l2:bg-primary">‚Üë</label>
                        <input type="radio" id="loc-TR" name="location" value="Top Right" class="hidden peer/l3"><label for="loc-TR" class="border p-1 text-center cursor-pointer peer-checked/l3:bg-primary">‚Üó</label>
                        <input type="radio" id="loc-CL" name="location" value="Center Left" class="hidden peer/l4"><label for="loc-CL" class="border p-1 text-center cursor-pointer peer-checked/l4:bg-primary">‚Üê</label>
                        <input type="radio" id="loc-CM" name="location" value="Center Middle" class="hidden peer/l5"><label for="loc-CM" class="border p-1 text-center cursor-pointer peer-checked/l5:bg-primary">‚Ä¢</label>
                        <input type="radio" id="loc-CR" name="location" value="Center Right" class="hidden peer/l6"><label for="loc-CR" class="border p-1 text-center cursor-pointer peer-checked/l6:bg-primary">‚Üí</label>
                        <input type="radio" id="loc-BL" name="location" value="Bottom Left" class="hidden peer/l7"><label for="loc-BL" class="border p-1 text-center cursor-pointer peer-checked/l7:bg-primary">‚Üô</label>
                        <input type="radio" id="loc-BM" name="location" value="Bottom Middle" class="hidden peer/l8"><label for="loc-BM" class="border p-1 text-center cursor-pointer peer-checked/l8:bg-primary">‚Üì</label>
                        <input type="radio" id="loc-BR" name="location" value="Bottom Right" class="hidden peer/l9"><label for="loc-BR" class="border p-1 text-center cursor-pointer peer-checked/l9:bg-primary">‚Üò</label>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mt-4 pt-2 border-t border-gray-700">
                    <button class="py-1 bg-green-600 font-bold rounded" onclick="instantSend()">‚ö°Instant</button>
                    <button class="py-1 bg-secondary font-bold rounded" onclick="saveButton()">üíæ SAVE</button>
                </div>
            </div>

            <p id="controller-feedback" class="text-lg mt-3 text-green-400 h-5"></p>
            <h2 class="text-base font-bold mt-0 mb-2 border-b border-gray-600 pb-1 w-full text-center">Saved Lowers</h2>
            <div id="saved-buttons-container" class="grid grid-cols-1 p-1 pt-0 pr-2 gap-2 w-full"></div>
        </div>

        <!-- Display Interface -->
        <div id="display-view" class="interface-view hidden">
            <div id="display-box" class="shadow-inner">
                <p id="action-name" class="text-6xl font-black text-center text-white text-shadow break-words max-w-full"></p>
                <h4 id="action-title" class="text-5xl font-bold text-center text-white text-shadow break-words max-w-full"></h4>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const SOCKET_URL = 'ws://localhost:8080';
        const STORAGE_KEY = 'studio_buttons';
        let ws = null;
        let isController = false;
        let displayTimeout = null; 

        // Stable LOCATION_MAP using margin auto for centering
   const LOCATION_MAP = {
            "Top Left": { top: '5vh', bottom: 'auto', left: '5vw', right: 'auto', margin: '0', textAlign: 'left', alignItems: 'flex-start', transform: 'none' },
            "Top Middle": { top: '5vh', bottom: 'auto', left: '0', right: '0', margin: '0 auto', textAlign: 'center', alignItems: 'center', transform: 'none' },
            "Top Right": { top: '5vh', bottom: 'auto', left: 'auto', right: '5vw', margin: '0', textAlign: 'right', alignItems: 'flex-end', transform: 'none' },
            
            "Center Left": { top: '50%', bottom: 'auto', left: '5vw', right: 'auto', margin: '0', textAlign: 'left', alignItems: 'flex-start', transform: 'translateY(-50%)' },
            "Center Middle": { top: '50%', bottom: 'auto', left: '0', right: '0', margin: '0 auto', textAlign: 'center', alignItems: 'center', transform: 'translateY(-50%)' },
            "Center Right": { top: '50%', bottom: 'auto', left: 'auto', right: '5vw', margin: '0', textAlign: 'right', alignItems: 'flex-end', transform: 'translateY(-50%)' },
            
            "Bottom Left": { top: 'auto', bottom: '5vh', left: '5vw', right: 'auto', margin: '0', textAlign: 'left', alignItems: 'flex-start', transform: 'none' },
            "Bottom Middle": { top: 'auto', bottom: '5vh', left: '0', right: '0', margin: '0 auto', textAlign: 'center', alignItems: 'center', transform: 'none' },
            "Bottom Right": { top: 'auto', bottom: '5vh', left: 'auto', right: '5vw', margin: '0', textAlign: 'right', alignItems: 'flex-end', transform: 'none' },
        };
        
        const loadButtonsFromStorage = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const saveButtonsToStorage = (b) => { localStorage.setItem(STORAGE_KEY, JSON.stringify(b)); renderButtons(b); };

        const clearFontClasses = (el) => {
            const fontClasses = ['font-default', 'font-script', 'font-fun', 'font-modern', 'font-classic', 'font-accent'];
            el.classList.remove(...fontClasses);
            document.getElementById('action-title').classList.remove(...fontClasses);
            document.getElementById('action-name').classList.remove(...fontClasses);
        };

        const clearAnimationClasses = (el) => {
    const anims = [
        'anim-slideUp', 'anim-slideDown', 'anim-slideLeft', 
        'anim-slideRight', 'anim-fade', 'anim-spinIn', 'anim-hide'
    ];
    el.classList.remove(...anims);
};
        const clearBgClasses = (el) => el.classList.remove('blue', 'green', 'black', 'red');

        const showDisplay = (data) => {
            const box = document.getElementById('display-box');
            const title = document.getElementById('action-title');
            const name = document.getElementById('action-name');
            if (displayTimeout) clearTimeout(displayTimeout);

            name.textContent = data.label;
            title.textContent = data.title || '';
            title.style.display = data.title ? 'block' : 'none';
            
            // Fonts
            clearFontClasses(box);
            const font = data.fontStyle || 'font-default';
            box.classList.add(font);
            title.classList.add(font);
            name.classList.add(font);

            // Background
            clearBgClasses(box);
            if (data.bgStyle) box.classList.add(data.bgStyle);
            
            // Positioning
            const loc = LOCATION_MAP[data.location];
            if (loc) {
                box.style.top = loc.top; box.style.bottom = loc.bottom;
                box.style.left = loc.left; box.style.right = loc.right;
                box.style.margin = loc.margin;
            }

            // Animations
            clearAnimationClasses(box);
            box.style.opacity = 0;
            void box.offsetWidth; 
            box.style.opacity = 1;
            box.classList.remove('anim-hide');
            box.classList.add(data.animationStyle || 'anim-slideUp');

            displayTimeout = setTimeout(() => { 
                // Clear the entrance animation class so it doesn't fight with the exit
                clearAnimationClasses(box);
                
                // Now trigger the exit animation
                box.classList.add('anim-hide');
                box.style.opacity = 0; 
            }, (data.duration || 5) * 1000); 
        };

        const connectWebSocket = () => {
            ws = new WebSocket(SOCKET_URL);
            ws.onopen = () => {
                const el = document.getElementById('controller-connection');
                if(el) { el.className = "text-green-400 font-bold"; el.textContent = "OPEN"; }
            };
            ws.onmessage = (e) => { if (!isController) showDisplay(JSON.parse(e.data)); };
            ws.onclose = () => setTimeout(connectWebSocket, 2000);
        };

        const sendWebSocketMessage = (title, label, location, fontStyle, duration, animationStyle, bgStyle) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ title, label, location, fontStyle, duration, animationStyle, bgStyle }));
            }
        };
        
        const getValues = () => {
            return {
                title: document.getElementById('title-input').value,
                label: document.getElementById('button-name-input').value,
                loc: document.querySelector('input[name="location"]:checked')?.value,
                font: document.querySelector('input[name="fontStyle"]:checked')?.value,
                dur: document.getElementById('duration-input').value,
                anim: document.querySelector('input[name="animationStyle"]:checked')?.value,
                bg: document.querySelector('input[name="bgStyle"]:checked')?.value
            };
        };

        const instantSend = () => {
            const v = getValues();
            if (v.label && v.loc) sendWebSocketMessage(v.title, v.label, v.loc, v.font, v.dur, v.anim, v.bg);
        };

        const saveButton = () => {
            const v = getValues();
            if (v.label && v.loc) {
                const b = loadButtonsFromStorage();
                b.unshift({ id: Date.now(), ...v, location: v.loc, fontStyle: v.font, duration: v.dur, animationStyle: v.anim, bgStyle: v.bg });
                saveButtonsToStorage(b);
            }
        };

        const renderButtons = (buttons) => {
            const container = document.getElementById('saved-buttons-container');
            container.innerHTML = ''; 
            buttons.forEach(data => {
                const div = document.createElement('div');
                div.className = 'flex mb-1  border-solid border-2  border-gray-500 rounded';
                div.innerHTML = `<button class="flex-grow text-white hover:text-blue-400 p-2  bg-gray-600 text-left lower-third rounded-l text-[14px]"><b class="block">${data.label}</b>${data.bgStyle} | ${data.fontStyle?.replace('font-', '')}</button>
                                 <button class="bg-red-900 p-2 delete-btn border-2 border-red-900 rounded-r text-black hover:text-yellow-200 text-[22px] h-full" onclick="deleteButton(${data.id}, '${data.label}')">X</button>`;
                div.firstChild.onclick = () => sendWebSocketMessage(data.title, data.label, data.location, data.fontStyle, data.duration, data.animationStyle, data.bgStyle);
                container.appendChild(div);
            });
        };

        const initializeView = () => {
            if (window.location.hash === '#display') {
                document.body.style.backgroundColor = 'transparent';
                document.getElementById('display-view').classList.remove('hidden');
                document.getElementById('display-box').style.opacity = 0;
            } else {
                document.getElementById('controller-view').classList.remove('hidden');
                isController = true;
                renderButtons(loadButtonsFromStorage());
            }
            connectWebSocket();
        };

        window.addEventListener('load', initializeView);
        window.deleteButton = function(id, label) { if(confirm(`Delete ${label}?`)) saveButtonsToStorage(loadButtonsFromStorage().filter(b => b.id !== id)); };
    </script>
</body>
</html